<!DOCTYPE html>
<html>
<head>
  <title>IP Logger with Firebase (multi API + IP fetch)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<h3>Logging your IP and location...</h3>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBmeCiF-qqHkaM81Jq-whaxvz4zJ6Ni3R0",
    authDomain: "yachad-32fe3.firebaseapp.com",
    projectId: "yachad-32fe3",
    storageBucket: "yachad-32fe3.appspot.com",
    messagingSenderId: "720032034735",
    appId: "1:720032034735:web:cabedda1dc842420bbc95a",
    measurementId: "G-YH1NK3RHY3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Fetch IP from ipify.org
  function fetchMyIP() {
    return fetch('https://api.ipify.org?format=json')
      .then(res => res.json())
      .then(data => {
        console.log('IP from ipify:', data.ip);
        return data.ip || null;
      })
      .catch(err => {
        console.error('Failed to fetch IP from ipify:', err);
        return null;
      });
  }

  // Helper: fetch from an API and return location info
  function fetchLocation(url, parser) {
    return fetch(url)
      .then(res => res.json())
      .then(data => {
        console.log("Raw data from", url, data);
        const parsed = parser(data);
        console.log("Parsed data:", parsed);
        return parsed;
      })
      .catch(err => {
        console.error("Error fetching from", url, err);
        return null;
      });
  }

  // Parse ip-api.com response
  function parseIpApi(data) {
    return {
      ip: data.query || null,
      lat: data.lat || null,
      lon: data.lon || null
    };
  }

  // Parse ipwho.is response
  function parseIpWhoIs(data) {
    if (data.success === false) return null;
    return {
      ip: data.ip || null,
      lat: data.latitude || null,
      lon: data.longitude || null
    };
  }

  // Run all
  Promise.all([
    fetchMyIP(),
    fetchLocation('https://ip-api.com/json/', parseIpApi),
    fetchLocation('https://ipwho.is/', parseIpWhoIs)
  ]).then(([ip, loc1, loc2]) => {
    const validLocations = [loc1, loc2].filter(l => l !== null);

    if (!ip && validLocations.length === 0) {
      document.body.innerHTML = "<p>Failed to get IP or location data.</p>";
      return;
    }

    // Use IP from ipify if available, else fallback to location IPs, else unknown
    const finalIP = ip || (validLocations.find(l => l.ip) ? validLocations.find(l => l.ip).ip : "unknown");

    // Average lat/lon
    let latSum = 0, lonSum = 0, count = 0;
    validLocations.forEach(loc => {
      if (loc.lat !== null && loc.lon !== null) {
        latSum += loc.lat;
        lonSum += loc.lon;
        count++;
      }
    });
    const avgLat = count ? latSum / count : null;
    const avgLon = count ? lonSum / count : null;

    const ua = navigator.userAgent;
    const time = new Date().toISOString();

    console.log("Saving to Firestore:", {ip: finalIP, userAgent: ua, timestamp: time, latitude: avgLat, longitude: avgLon});

    db.collection('ipLogs').add({
      ip: finalIP,
      userAgent: ua,
      timestamp: time,
      latitude: avgLat,
      longitude: avgLon
    }).then(() => {
      document.body.innerHTML = "<p>Your IP and location have been logged. Thanks!</p>";
    }).catch(err => {
      document.body.innerHTML = "<p>Error logging IP/location: " + err + "</p>";
    });
  });
</script>
</body>
</html>
