<!DOCTYPE html>
<html>
<head>
  <title>IP Logger with Firebase (multi API)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<h3>Logging your IP and location...</h3>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBmeCiF-qqHkaM81Jq-whaxvz4zJ6Ni3R0",
    authDomain: "yachad-32fe3.firebaseapp.com",
    databaseURL: "https://yachad-32fe3-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "yachad-32fe3",
    storageBucket: "yachad-32fe3.firebasestorage.app",
    messagingSenderId: "720032034735",
    appId: "1:720032034735:web:cabedda1dc842420bbc95a",
    measurementId: "G-YH1NK3RHY3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Helper: fetch from an API and return location info
  function fetchLocation(url, parser) {
    return fetch(url)
      .then(res => res.json())
      .then(parser)
      .catch(() => null); // ignore errors
  }

  // Parse ip-api.com response
  function parseIpApi(data) {
    return {
      ip: data.query || null,
      lat: data.lat || null,
      lon: data.lon || null
    };
  }

  // Parse ipwho.is response
  function parseIpWhoIs(data) {
    if (data.success === false) return null;
    return {
      ip: data.ip || null,
      lat: data.latitude || null,
      lon: data.longitude || null
    };
  }

  Promise.all([
    fetchLocation('https://ip-api.com/json/', parseIpApi),
    fetchLocation('https://ipwho.is/', parseIpWhoIs)
  ]).then(results => {
    // Filter out null results
    const validResults = results.filter(r => r !== null);

    if (validResults.length === 0) {
      document.body.innerHTML = "<p>Failed to fetch location from all APIs.</p>";
      return;
    }

    // Pick the first IP (usually same), and average lat/lon if multiple
    const ip = validResults[0].ip || "unknown";

    // Average lat/lon
    let latSum = 0, lonSum = 0, count = 0;
    validResults.forEach(r => {
      if (r.lat !== null && r.lon !== null) {
        latSum += r.lat;
        lonSum += r.lon;
        count++;
      }
    });
    const avgLat = count ? latSum / count : null;
    const avgLon = count ? lonSum / count : null;

    const ua = navigator.userAgent;
    const time = new Date().toISOString();

    // Save to Firestore
    db.collection('ipLogs').add({
      ip: ip,
      userAgent: ua,
      timestamp: time,
      latitude: avgLat,
      longitude: avgLon
    }).then(() => {
      document.body.innerHTML = "<p>Your IP and location have been logged. Thanks!</p>";
    }).catch(err => {
      document.body.innerHTML = "<p>Error logging IP/location: " + err + "</p>";
    });

  }).catch(err => {
    document.body.innerHTML = "<p>Unexpected error: " + err + "</p>";
  });
</script>
</body>
</html>
